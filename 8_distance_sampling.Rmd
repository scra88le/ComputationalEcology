---
title: "Distance Sampling"
---

# Introduction - detecting rare species in multi-species survey

This vignette is based upon a vignette by Erix Rexstad at the CREEM, St Andrews University[^1]. The underlying data for the analysis presented is part of an ongoing survey within the Naboisho conservancy within the greater Mara ecosystem, and is led by Professor Stewart Thompson[^2]. The project uses *distance sampling* techniques to record observations across 9 different transects within the conservancy. The overall aim of the project is to provide an evidence based approach for the ecological outcomes of conservancy partnerships between indigenous land owners and private investors.

## Distance sampling

Distance sampling [^3] is a statistical method that can be used for estimating population densities and abundance. Typically an observer traverses a straightline (a transecrt) that is randomly loated within the study area. On observing a species of interest, the distance from the observer to the observed species is recorded (*r*), as well as the angle of detection ($\theta$) to the transect line. The distance between the species detected and the transect line may then be calculatd as $d = r \sin \theta$.

Once a number of detections have been made along a transect, the set of distance data, $d$, can be used to estimate a *detection function*. This describes the probability of detecting a given species at a given distance. In effect, the detection models the *detectability* or species distribution across the landscape for a given habitat, and so helps to account for species that were undetected when the observer traversed the transect(s) in question. A key assumption is that all species at zero distance (on the transect) are detected; that is, detectability at zero distance has probabiliy 1.

Species density, $D$, within a given survey area, $A$, may then be determined as:

$D= n/(P.A)$

Where $n$ = number of species detected, and $P$ is the average probability of detecting a species within width *w* of a transect line. 

## Multi-species surveys

The Naboisho data is an example of a multi-species survey. <more stuff here>

```{r message=FALSE, warning=FALSE}
# Load some libraries to get started
library(Distance)
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
library(kableExtra)

# Clear environment and set working directory
rm(list = ls())  
wd = "/Users/anthony/Documents/GitHub/ComputationalEcology/data_analysis_files/"
setwd(wd)

# Load underlying survey data
clean_obs <- read.csv("clean_obs.csv", stringsAsFactors = F)
```

# Clean the data

Before we can proceed with our distance sampling analysis, we load all observations from the Naboisho surveys, from 2017 to 2019. This is a multi-species survey comprising:

* Nine different transects
* Two habitat types: woodland and plains
* Transect are typically driven throughout the year, several times a month

```{r format_Data}
# Remove rows with no species or transect data
clean_obs <- clean_obs %>%
  # Remove observations with no species field
  filter(Species != "") %>%      
  # Data that is classified as woodlands and plains
  filter(Woodland != "" & Plains == "" | Woodland == "" & Plains != "") 
  
# Reformat
data_clean <- clean_obs %>%
  # Create a column to indicate Region type
  mutate(Region.Label = case_when(
    Plains == "" ~ "Woodland",
    Plains != "" ~ "Plains")) %>%
  # Create a single column for all transect names
  mutate(Transect = case_when(
    Region.Label == "Woodland" ~ as.character(Woodland),
    Region.Label == "Plains"   ~ as.character(Plains))) %>%
  # Add in region area for each observation stratum
  mutate(Area = case_when(
    Region.Label == "Woodland" ~ as.numeric(165.763 * 1000),         
    Region.Label == "Plains"   ~ as.numeric(36.579  * 1000))) %>% 
  # Create a new column for the date
  mutate(Year = lubridate::dmy(as.character(Date)) %>% lubridate::year()) %>%
  # Add a new column for the month of the year
  mutate(Month = lubridate::month(as.character(Date), label= T, abbr = T)) %>%
  # Drop columns we dont need anymore
  dplyr::select(-c("Woodland","Plains")) %>%
    # Rename the Transect column to Sample.Label
  rename(Sample.Label = Transect) %>%
  # Drop any rows with NA
  drop_na()

# Plot

```

# Analysis periods

We want to generate a detection function and ultimately a density estimate for each species by:

* Year
* Month
* Habitat type

In order to capture all the necessary permutations we can use `expand.grid` to do this as follows:

```{r param_grid}
# Generate all combinations to execute species estimates
ds_params <- expand.grid(Region.Label = c("Plains","Woodland"),
                      Year = c(2017, 2018),
                      Month = c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")) 

# Make the factor levels on month variable the same in ds_params and data_clean
data_clean <- data_clean %>%
  mutate(Month = factor(Month, ordered = FALSE, levels = levels(ds_params$Month)))

# Take a look at the data structure
head(ds_params)
```

# Generating datasets for each analysis period

We can now use `ds_params` together with the `purrr::map` function to subset our data set of all observations to create a subset for each row within `ds_params`.

```{r subset_data}
# Create all data set permutations for ddf calc
ds_data <- pmap_df(
  # Paramters for subsetting the data
  ds_params,
  # Filter the dataset by ds_params
  ~dplyr::filter(
    # Data to subset
    data_clean,
    #  By strata, Year and Month
    Region.Label == ..1,
    Year         == ..2,
    Month        == ..3)) %>%
  # Add effort column
  group_by(Sample.Label) %>%       
  mutate(Effort = length(unique(Date)) * 2) %>%
  ungroup() %>%
  # Nest the output data
  group_by(Region.Label,Year,Month) %>% nest()
```


# Calculating species detectability  

```{r calc_ds, message=FALSE, warning=FALSE}
# Generate a distance model for each dataset
ds_data <- ds_data %>%
  mutate(
    model = map(
      data, 
      # Catch model failures
      possibly(
        ~ds(
          # Call distance function
          data = as.data.frame(.) ,
          # Use a half-normal fit
          key="hn",
          # Convert distances (m) to km
          #convert.units = 0.001,
          # Use species observed as covariate
          formula = ~Species),
        # Retrun NULL if fit fails
        otherwise = NULL)))
```

# Calculating species abundance

Now we can calculate the abundance of individual species within the overall dataset, for each calculation period.

```{r calc_abun, message=FALSE, warning=FALSE}

# Function to generate species abundance
# The function stratifies by species
dht2_poss <- function (.x, .y) {
    dht2(
      ddf = .y,
      flatfile = as.data.frame(.x),
      strat_formula = ~Species, 
      stratification = "object")
}
                     
# Generate species specific abundance estiamtes
ds_data <- ds_data %>%
  mutate(abun_model = map2(
    # Given underlying data set by month/strate
    .x = data, 
    # And distance model
    .y = model,
    # Catch failed dht2 fits
    possibly(~dht2_poss(.x,.y), 
             # Return NULL if failure
             otherwise = NULL)))

# Examine final data structure
head(ds_data)
```

# Results

Output a detailed results table

```{r output_results, message=FALSE, warning=FALSE, fig.align='centre'}
# Create a table of results that we're interested in
tab <- ds_data %>% unnest(abun_model) %>%
  dplyr::select(Year, Month, Region.Label, Species, Abundance, LCI, UCI) %>%
  # group by Year, Month and strata
  group_by(Year, Month, Region.Label) %>%
  # Set precision on doubles
  mutate_if(is.double, format, digits=2, scientific = FALSE) %>%
  mutate(Density = case_when(
    Region.Label == "Woodland" ~ as.numeric(Abundance) / 165.763,
    Region.Label == "Plains"   ~ as.numeric(Abundance) / 36.579
  ))

# Foramt the table using Kable Extra
kableExtra::kable(tab, align = "c", col.names = c("","", names(tab)[3:8])) %>%
  kable_styling(full_width = F, font_size = 10) %>%
  column_spec(1, bold = T) %>%
  collapse_rows(columns = 1:3, valign = "top") %>%
  scroll_box(width = "800px", height = "500px")
```

# Discussion

tbd

# References

[^1]: Covariate modeling with rare species, Rexstad, E. http://examples.distancesampling.org/Distance-spec-covar/species-covariate-distill.html
[^2]: Spatial Ecology and Landuse Unit, Oxford Brookes University.  https://www.brookes.ac.uk/bms/research/groups/evolution-ecology-environment-and-conservation/conservation-ecology/spatial-ecology-and-landuse-unit-selu/
[^3]: Introduction to Distance Sampling, Centre for Research into Ecological and Environmental Modelling http://workshops.distancesampling.org/standrews-2019/intro/lectures/BlockA-introDS.pdf
