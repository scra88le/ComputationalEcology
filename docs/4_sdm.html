<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Species Distribution Modelling</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Computational Ecology</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="1_data_analysis.html">Data Analysis</a>
    </li>
    <li>
      <a href="2_glm.html">Generalised Linear Models</a>
    </li>
    <li>
      <a href="3_gam.html">Generalised Additive Models</a>
    </li>
    <li>
      <a href="4_sdm.html">Distribution Modelling</a>
    </li>
    <li>
      <a href="5_eDNA.html">Environmental DNA</a>
    </li>
    <li>
      <a href="6_sam_naboisho.html">Geostatistics</a>
    </li>
    <li>
      <a href="7_movement_BA055.html">Movement Modelling</a>
    </li>
    <li>
      <a href="8_distance_sampling.html">Distance Sampling</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Species Distribution Modelling</h1>

</div>


<pre class="r"><code># Load libraries
library(tidyverse)
library(lubridate)
library(caret)
library(raster)
library(reshape2)
library(viridis)

# Clear environment and set working directory
rm(list = ls())  </code></pre>
<p>We can use the Global Biodiversity Information Facility (GBIF) to gather presence records for the migratory hoverfly <em>Volucella zonaria</em>, also known as the hornet mimic hoverfly. In Great Britain, it was only known from two specimens prior to 1940, so was regarded as rare. Since then, it has become increasingly widespread in many parts of the South and South East England, often in association with parks and gardens, where adults are usually seen visiting flowers. Elsewhere across England, only a few scattered records exist.</p>
<p>The observation records were retrieved from the GBIF API, and the data cleanded as follows:</p>
<pre class="r"><code># load the data from a query to GBIF, for V. Zonaria
gbif_response &lt;- read_rds(&quot;~/Documents/GitHub/ComputationalEcology/data_analysis_files/clim_data/gbif_volucella_zonaria.rds&quot;)

# Create presence records across decades
zonaria_clean &lt;- gbif_response$data %&gt;%
  # get decade of record from eventDate
  mutate(decade = eventDate %&gt;% 
           ymd_hms() %&gt;% 
           round_date(&quot;10y&quot;) %&gt;% 
           year() %&gt;% 
           as.numeric()) %&gt;%
  rename(y = decimalLatitude,
         x = decimalLongitude) %&gt;%
  # clean data using metadata filters
  filter(
    # only records with no issues
    issues == &quot;&quot; &amp;
    # let&#39;s take data from 2000 to 2020
    decade %in% c(2010,2020)) %&gt;%
  # retain only relevant variables
  dplyr::select(x, y, decade,scientificName) %&gt;% arrange(decade)</code></pre>
<div id="covariates" class="section level1">
<h1><span class="header-section-number">1</span> Covariates</h1>
<p>Now we need to grab some environmental data. For this vignette we will use the worldclim database as this is directly available via the <code>raster</code> package. We can download 19 bioclimatic variables at 10’ resolution. They are coded as follows:</p>
<ul>
<li>BIO1 = Annual Mean Temperature</li>
<li>BIO2 = Mean Diurnal Range (Mean of monthly (max temp - min temp))</li>
<li>BIO3 = Isothermality (BIO2/BIO7) (* 100)</li>
<li>BIO4 = Temperature Seasonality (standard deviation *100)</li>
<li>BIO5 = Max Temperature of Warmest Month</li>
<li>BIO6 = Min Temperature of Coldest Month</li>
<li>BIO7 = Temperature Annual Range (BIO5-BIO6)</li>
<li>BIO8 = Mean Temperature of Wettest Quarter</li>
<li>BIO9 = Mean Temperature of Driest Quarter</li>
<li>BIO10 = Mean Temperature of Warmest Quarter</li>
<li>BIO11 = Mean Temperature of Coldest Quarter</li>
<li>BIO12 = Annual Precipitation</li>
<li>BIO13 = Precipitation of Wettest Month</li>
<li>BIO14 = Precipitation of Driest Month</li>
<li>BIO15 = Precipitation Seasonality (Coefficient of Variation)</li>
<li>BIO16 = Precipitation of Wettest Quarter</li>
<li>BIO17 = Precipitation of Driest Quarter</li>
<li>BIO18 = Precipitation of Warmest Quarter</li>
<li>BIO19 = Precipitation of Coldest Quarter</li>
</ul>
<p>Let’s download data for the current bioclim a rasters:</p>
<pre class="r"><code># Load UK background mask
bg &lt;- raster(&quot;data_analysis_files/UK_bg.grd&quot;)

# Reproject to lat/lon
bg &lt;- projectRaster(bg, crs= &quot;+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs&quot;)

# UK extent in lon/lat coordinates
ext_uk &lt;- c(-12, 3, 48, 62)

# Get climate data for current date
filepath = &quot;~/Documents/GitHub/ComputationalEcology/data_analysis_files/clim_data/&quot;
bio_curr &lt;- raster::getData(&#39;worldclim&#39;, var=&#39;bio&#39;, download=F, lon=-5, lat=55, res=5, path=filepath)

# Crop and reproject current climate
bio_curr &lt;- crop(bio_curr, ext_uk)
bio_curr &lt;- projectRaster(bio_curr, bg)
bio_curr &lt;- resample(bio_curr, bg)
bio_curr &lt;- mask(bio_curr, bg)</code></pre>
<div id="autocorrelation" class="section level2">
<h2><span class="header-section-number">1.1</span> Autocorrelation</h2>
<p>Using adjacent cells in building a model can cause problems with spatial autocorrelation. We can therefore, thin the observations using the package <code>spThin</code>, as shown below. We set a minimum spatial distance between observations of 10km. The plot below shows the retained spatially thinned <em>V. zonaria</em> observations.</p>
<pre class="r"><code># Load library
library(spThin)
# Generate thinned data
thinned_zonaria &lt;- thin(
  # Observtion data to thin
  zonaria_clean,
  # Longitude and Latitude data
  lat.col = &quot;y&quot;, long.col = &quot;x&quot;, 
  # Column that reperesents species
  spec.col = &quot;scientificName&quot;, 
  # Minimum distance (in km) that records should be separated by 
  thin.par = 10, 
  # The process is random, so repeat three times
  reps=10,
  # We dont wish to see or write the output
  locs.thinned.list.return = T,
  write.files = F, 
  write.log.file = F)</code></pre>
<pre><code>## ********************************************** 
##  Beginning Spatial Thinning.
##  Script Started at: Mon Mar 30 11:15:19 2020
## lat.long.thin.count
## 89 90 91 92 
##  1  3  4  2 
## [1] &quot;Maximum number of records after thinning: 92&quot;
## [1] &quot;Number of data.frames with max records: 2&quot;
## [1] &quot;No files written for this run.&quot;</code></pre>
<pre class="r"><code># Select sample with largest number of thinned 0observations
sample_index &lt;- which.max(sapply(thinned_zonaria,nrow))
thinned_zonaria &lt;- data.frame(x = thinned_zonaria[[sample_index]]$Longitude, 
                           y = thinned_zonaria[[sample_index]]$Latitude) %&gt;%
  mutate(obs = &quot;thinned&quot;)

# Make dataframe of background raster
bg_df &lt;- as(bg, &quot;SpatialPixelsDataFrame&quot;) %&gt;% 
  as.data.frame()

# Name the dataframe columns
colnames(bg_df) &lt;- c(&quot;value&quot;, &quot;x&quot;, &quot;y&quot;)

# Generate a plot of observations a cross the UK
rbind(thinned_zonaria, zonaria_clean[1:2] %&gt;% mutate(obs= &quot;full&quot;)) %&gt;%
  ggplot() +
  geom_raster(data=bg_df, aes(x=x, y=y)) +
  geom_point(aes(x=x, y=y, colour = obs), 
             size = 0.5) +
  theme_bw() +
  facet_wrap(~obs)</code></pre>
<p><img src="4_sdm_files/figure-html/thin_obs-1.png" width="672" /></p>
</div>
<div id="bioclim-data" class="section level2">
<h2><span class="header-section-number">1.2</span> Bioclim data</h2>
<p>We can plot the current bioclim data - all 19 covariates:</p>
<pre class="r"><code># Function to generate individual plots
plot_bioclim &lt;- function(df, name) {
  ggplot(data = df, aes(x=x, y=y, fill = value)) + 
  geom_tile() +
  coord_equal() +
  scale_fill_viridis(name = name) +
  theme(
    plot.margin = rep(unit(0,&quot;null&quot;),4),
    panel.spacing = unit(0,&quot;null&quot;),
    legend.key.width = unit(0.01,&quot;null&quot;)
    ) +
  theme_bw()
}

# extract all bioclim values by xy
nested_bioclim_plots &lt;- data.frame(rasterToPoints(bio_curr)) %&gt;%
  # Create single gouping variable by which to facet chart
  melt(id = c(&quot;x&quot;,&quot;y&quot;)) %&gt;%
  # Nest data by bioclim variable
  nest(-variable) %&gt;%
  # Create individual ggplots
  mutate(plots = map2(.x = data, 
                      .y = variable, 
                      .f = plot_bioclim))

# Render plots
library(gridExtra)
margin = theme(plot.margin = rep(unit(0,&quot;null&quot;),4))
gridExtra::grid.arrange(grobs = nested_bioclim_plots$plots,
                        top=&quot;Current UK Bioclim variables &quot;,
                        ncol = 2,
                        margin
                        )</code></pre>
<p><img src="4_sdm_files/figure-html/plot_uk_bioclim-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>For each bioclim variable, we want to extract its value for the location of each V. zonaria observation. We also need to create pesudo-absence data - this represents locations where no observations were made. The covariates then need to be joined to the location of each observation to give an overall dataset from which we can build our species distribution model for V. zonaria.</p>
<pre class="r"><code>df_presence &lt;- zonaria_clean[1:2] %&gt;%
  # Extract bioclim + lcm variables using long/lat
  raster::extract(bio_curr, .) %&gt;%
  # Add extracted variables to long/lat
  cbind(zonaria_clean) %&gt;%
  # Mark observation data as presence records
  mutate(presence = 1) %&gt;%
  # Drop unecessary columns
  dplyr::select(-decade, -scientificName)
  
# Function to pick raster cells at random from bioclim layers
raster_random_sample &lt;- function(r_covars, n_samples, xy_coords) {
  # Set seed for repeatable results
  set.seed(12345)
  raster::sampleRandom(
    x = r_covars, 
    size = n_samples,
    na.rm = TRUE,
    xy = xy_coords) 
  }

# Sample background points (psedo absent?) from covariate raster 
df_absence &lt;- raster_random_sample(bio_curr, 100, T) %&gt;%
  as.data.frame() %&gt;%
  # Mark as background data
  mutate(presence = 0)

# Create single dataframe for presence and absence data
df_zonaria &lt;- rbind(df_presence, df_absence)</code></pre>
</div>
</div>
<div id="variable-selection" class="section level1">
<h1><span class="header-section-number">2</span> Variable selection</h1>
<p>In order to avoid collinearity we should remove covariates with absolute correlation of 0.8 or higher. We can achieve this by calculating a correlation matrix.</p>
<pre class="r"><code># Generate correlation matrix with covariates as correlates
cor_mat &lt;- cor(df_zonaria %&gt;% dplyr::select(-x,-y,-presence), method=&quot;spearman&quot;)
# Subset covariates that are highly correlated
highlyCorrelated &lt;- findCorrelation(cor_mat, cutoff=0.8)
# Generate column names to remove
cols_to_remove &lt;- names(df_zonaria[highlyCorrelated])
# Remove highly correlated variables from df
df_zonaria &lt;- df_zonaria %&gt;% dplyr::select(-cols_to_remove)
# What covarites are weekly correlated
head(df_zonaria)</code></pre>
<pre><code>##       bio2     bio3     bio4     bio5     bio8     bio9    bio11    bio15
## 1 64.48101 32.00000 4799.870 206.8308 75.69390 61.83747 39.77803 13.91587
## 2 64.48101 32.00000 4799.870 206.8308 75.69390 61.83747 39.77803 13.91587
## 3 61.46156 31.77255 4687.255 205.8329 80.00000 62.14391 43.53844 15.31099
## 4 61.46156 31.77255 4687.255 205.8329 80.00000 62.14391 43.53844 15.31099
## 5 72.06501 34.06501 4812.766 207.2257 78.24089 58.93499 34.00000 13.29069
## 6 72.06501 34.06501 4812.766 207.2257 78.24089 58.93499 34.00000 13.29069
##      bio18       x        y presence
## 1 162.2590 1.32073 52.59618        1
## 2 162.2590 1.32073 52.59618        1
## 3 168.0000 1.63029 52.76698        1
## 4 168.0000 1.63029 52.76698        1
## 5 147.0461 0.75289 52.01723        1
## 6 147.0461 0.75289 52.01723        1</code></pre>
<p>Now we have joined our environmental and observation data together into one dataset, we can begin to build a species distribution model. First we need to create a categorical response variable as we want to model presence v absence in space:</p>
<pre class="r"><code># last pre-processing step
df_modelling &lt;- df_zonaria %&gt;%
  # caret requires a factorial response variable for classification
  mutate(presence = case_when(
    presence == 1 ~ &quot;presence&quot;,
    presence == 0 ~ &quot;absence&quot;) %&gt;%
    as.factor()) %&gt;%
  # drop all observations with NA variables
  na.omit()</code></pre>
<p>Before we undertake any machine learning, we need to split the data into training and test sets. We give 60% of the data over to training with the remainder used to test the model fit:</p>
<pre class="r"><code># for reproducibility
set.seed(12345)
# Create index for splitting
inTrain  &lt;- createDataPartition(y = df_modelling$presence, p = 0.6, list = FALSE)
# Create training dataset
training &lt;- df_modelling[inTrain,]
# Create testing dataset
testing  &lt;- df_modelling[-inTrain,]</code></pre>
</div>
<div id="random-forest" class="section level1">
<h1><span class="header-section-number">3</span> Random Forest</h1>
<p>Now we have removed the most highly correalted variables, we have nine <code>bio_clim</code> variables to as covarites to build a model fit. We’ll fit the model using a random forest. A Random Forest is a machine larning classifier that builds a number <em>decision trees</em>. The idea is to build a forest of uncorrelated decision, conditioned on our covariates. The resulting forest has an decision structure that can accurately classify our decision model; in this case presence or absence at a location, given a set of <code>bio_clim</code> covariates.</p>
<pre class="r"><code>library(randomForest)

# Use five fold cross validation, repeated twice
tunecontrol &lt;- trainControl(
  # Use 5-fold cross validation
  method = &#39;cv&#39;,
  number = 5,
  # Repeated cv 3 times
  repeats = 3,
  # Use a grid for hyper-parameters
  search = &quot;grid&quot;)

# Create tuning parameters as grid
tunegrid &lt;- expand.grid(.mtry=c(3:9))

# for reproducibility 
set.seed(12345)

# actual model build
model_fit &lt;- train(
  # Our formular for classifications
  presence ~ .,
  # Data to train the RF classifier
  data = training,
  # Train using a Random Forest
  method = &quot;rf&quot;,
  # Return an accuracy metrix
  metric = &quot;Accuracy&quot;,
  # Run the model using 
  tuneGrid = tunegrid,
  trControl = tunecontrol,
   # Normalise the covariate data
  preProcess = c(&quot;center&quot;, &quot;scale&quot;)
  )

print(model_fit)</code></pre>
<pre><code>## Random Forest 
## 
## 348 samples
##  11 predictor
##   2 classes: &#39;absence&#39;, &#39;presence&#39; 
## 
## Pre-processing: centered (11), scaled (11) 
## Resampling: Cross-Validated (5 fold) 
## Summary of sample sizes: 279, 279, 278, 278, 278 
## Resampling results across tuning parameters:
## 
##   mtry  Accuracy   Kappa    
##   3     0.9338302  0.7305669
##   4     0.9338302  0.7305669
##   5     0.9338716  0.7279421
##   6     0.9395859  0.7546974
##   7     0.9367288  0.7427430
##   8     0.9424845  0.7686002
##   9     0.9338716  0.7331589
## 
## Accuracy was used to select the optimal model using the largest value.
## The final value used for the model was mtry = 8.</code></pre>
<pre class="r"><code>plot(model_fit)</code></pre>
<p><img src="4_sdm_files/figure-html/model_fit-1.png" width="672" /> # Confusion matrix</p>
<p>We can assess how good model predictions by generating a confusion matrix. This matrix shows a cross-tabulation of the observed and predicted classes, as well as a number of metrics that provide an inisght into how good the model predictions were compared to a reference data set. The referece dataset in our case was the reserved <em>training</em> data.</p>
<pre class="r"><code># Make prediction
pred &lt;- predict(model_fit, testing)
# Generate confusion matrix
confusionMatrix(
  # Predicted classification results
  data = pred, 
  # Reference data - use partioned test data
  reference = testing$presence, 
  # Definition of positive result
  positive = &quot;presence&quot;)</code></pre>
<pre><code>## Confusion Matrix and Statistics
## 
##           Reference
## Prediction absence presence
##   absence       25        8
##   presence      15      183
##                                           
##                Accuracy : 0.9004          
##                  95% CI : (0.8544, 0.9358)
##     No Information Rate : 0.8268          
##     P-Value [Acc &gt; NIR] : 0.001174        
##                                           
##                   Kappa : 0.6265          
##                                           
##  Mcnemar&#39;s Test P-Value : 0.210903        
##                                           
##             Sensitivity : 0.9581          
##             Specificity : 0.6250          
##          Pos Pred Value : 0.9242          
##          Neg Pred Value : 0.7576          
##              Prevalence : 0.8268          
##          Detection Rate : 0.7922          
##    Detection Prevalence : 0.8571          
##       Balanced Accuracy : 0.7916          
##                                           
##        &#39;Positive&#39; Class : presence        
## </code></pre>
<p>Some definitions:</p>
<ul>
<li>Accuracy - overall probability that a response is correctly classified. Accuracy = Sensitivity × Prevalence + Specificity × (1 − Prevalence)</li>
<li>Sensitivity - true positive rate of the <em>positive</em> class. How well did the model detect presence?</li>
<li>Specificity - true negative rate. How well did the model detect absence?</li>
<li>Positive Predictive Value - probability that V. Zonaria is present when the model returns a presence</li>
<li>Negative Predictive Value - probability that V. Zonaria is absent when the model returns an absence</li>
</ul>
<p>We can see the accuracy is around 91%. So the model is looking good.</p>
</div>
<div id="plot-prediction" class="section level1">
<h1><span class="header-section-number">4</span> Plot prediction</h1>
<p>Now we can now make a prediction for the current species distribution range for V. zonaria, using the bioclim covariates.</p>
<pre class="r"><code># Generate distribution data from raster to run model on
dist_dat &lt;- data.frame(rasterToPoints(bio_curr)) %&gt;% 
  # Select variables required for prediction
  dplyr::select(head(names(training), -1)) %&gt;%
  na.omit()

# Set seed for repeatable results
set.seed(12345)

# Create a probability of presence/absence raster
r_pred &lt;- rasterFromXYZ(
  cbind(
  # Coordinates to make prediction from
  dist_dat %&gt;% dplyr::select(x,y),

  # Predict with RF species distribution model 
    predict(model_fit, 
    # Use covariates to run model against
    dist_dat, 
    # Type of response variable
    type=&#39;prob&#39;)))
     
# Create spatial dataframe for plotting
df_prob_presence &lt;- as(r_pred[[2]], &quot;SpatialPixelsDataFrame&quot;) %&gt;% as.data.frame()

# Plot scenarios
df_prob_presence %&gt;% 
ggplot() + 
  geom_raster(aes(x=x, y=y, fill=presence)) +
  coord_equal() +
  scale_fill_viridis() +
  theme_bw()</code></pre>
<p><img src="4_sdm_files/figure-html/predict_and_plot-1.png" width="960" /></p>
<p>We see the range fo V.zonaira is largely confined to south of Liverpool, with a random dot around Glasgow.</p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
