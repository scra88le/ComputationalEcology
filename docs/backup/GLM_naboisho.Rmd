---
title: "Generalised Linear Models"

---

This vignette examines the application of statistical regresssion techniques to ecological data sets.

```{r, load_naboisho_data, echo=F, warning=F, message=F}
rm(list = ls())  
setwd("/Users/anthony/Documents/GitHub/ComputationalEcology/")
naboisho <- read.csv("data_analysis_files/Naboisho_target_format.csv")
weather <- read.csv("data_analysis_files/naboisho_precip.csv")

# Load libs
library(tidyverse)
library(lubridate)
library(zoo)
```

```{r create_dataset}
# Moving average function for rainfall calc
ma <- function(x, w) rollmean(x, w, na.pad=TRUE,align = "right")

# Create moving average rainfail data
weather <- weather %>%
  mutate(Precip_5d_MA =  ma(.$PRECTOT,5),
         Precip_10d_MA = ma(.$PRECTOT,10),
         Precip_20d_MA = ma(.$PRECTOT,20))
```

```{r plot_weather_MA}
# Plot the different moving averages
weather %>%
  filter(YEAR == 2017) %>%
  ggplot() +
    geom_line(aes(x=Date,y=PRECTOT, group=1), colour = "black", linetype = "dashed", alpha=0.5) +
    geom_line(aes(x=Date,y=Precip_5d_MA, group=1), colour = "red") +
    geom_line(aes(x=Date,y=Precip_20d_MA, group=1), colour = "blue") +
    labs(x = "Date", y = "Precipitation (mm)") +
    theme(legend.position="top")

```

First lets tag each observation with a month, and select only Zebra observations to start with.

```{r message=FALSE, warning=FALSE}
# Create common date format in both datasets
weather$Date <- dmy(weather$Date) %>% date()
naboisho$Date <- ymd(naboisho$Date) %>% date()

# Join datasets by Date
naboisho <- left_join(naboisho, weather, "Date", keep=F) %>%
  # Only keep records that have valid rainfall data
  filter(!is.na(.$PRECTOT)) %>%
  # We don't need the date column
  select(-Date) %>%
  # Correct the fact that observations are recored with 0 size
  mutate_all(funs(replace(., size == 0, 1)))

# Create the data structure we need for fitting a model
species_filtered <- naboisho %>% 
  # Filter species recorded as None
  filter(species != "None", 
         !is.na(species), 
         !is.null(species),
         !is.na(size), 
         !is.null(size)) %>%
  # Count testable data
  count(species, year) %>%
  # Remove any data less with a count less than 10
  filter(n>50) %>%
  # Create testable data set
  left_join(naboisho) %>%
  # Make all size recorded as 0 equal to 1
  mutate_all(funs(replace(., size == 0, 1))) %>%
  # Let's look at Woodland observations only
  filter(Region.Label == "Woodland") %>%
  # Nest each species group
  filter(!is.na(species)) %>%
  filter(species == "Wildebeest") 

```

```{r size_dispersion}
species_filtered %>%
  ggplot(aes(size)) +
  geom_histogram(binwidth=1)
# What is the mean of the species size?
mean(species_filtered$size)
# What is the variance of the species size?
var(species_filtered$size)
```
We can see that the data has a very long right tail; it's over dispersed. This means the variance is significanrly higher than the mean. So we'll use a poisson distribution to fit the size data against moving average rainfall.

Now we can first a simple poisson regression model, which is often used for modelling count data. Here we look at group sizes observed across the *woodland* transects of the Naboisho data.

```{r zebra_size_poisson}
library(mvabund)
species_poisson <- glm(formula = size ~ PRECTOT + Precip_5d_MA + Precip_10d_MA + Precip_20d_MA, 
                       family= poisson("identity"), 
                       data = species_filtered)
summary(species_poisson)
```


```{r predict_repsonse}
newdata <- seq(0,25, 0.1)
p <- species_filtered[order(species_filtered$Precip_5d_MA),]
p$phat <- predict(species_poisson, newdata = p, type="response")
```

The sign of the coefficient indicates that as the size of the covariate changes, the mean size of a species will also change in the same direction. 
```{r plot_mode}
#months <- list(c("Jan", "Feb","Mar","Apr","May","Jun", "Jul", "Aug", "Sep","Oct", "Nov", "Dec")) 
#species_filtered <- species_filtered %>% filter(size < 300)
ggplot(data = p, aes(x=Precip_5d_MA, y=phat)) +
  geom_point(aes(y=size), alpha = 0.5) +
  geom_smooth(size=0.5, colour= "Red" )
#lines(months,Y)

```

We can look at the variance of the residuals by performing an anova test

```{r anova_test_residuals}
anova(species_poisson)
```

```{r glm_by_species}
library(broom)

# Run glm for each species that has enough data
model_glm <- species_filtered %>% 
  nest(-species) %>%
  mutate(model = map(data, ~glm(size ~ PRECTOT, family = "poisson", data = .x)),
         res   = map(model, broom::tidy)) %>%
  select(-data) %>%
  unnest(res)
summary(model_glm)
```

```{r load_doubs}
library(reshape2)
library(ade4)

#Let's load the data
data(doubs)

# Set-up species data
species <- doubs$fish
species$site <- 1:30

# Set-up environmental data
environ <- doubs$env
environ$site <- 1:30

# Join into one dataset
species_environ <- full_join(species, environ, "site")
```

```{r species_glm}
species_model <- glm(formula = species$Ruru ~ . ,  
                       family= poisson, 
                       data = environ)
summary(species_model)
```
```{r skim_data}
library(skimr)
skim(environ)
skim(species)
```

We are going otbe use the `caret` package for running all model fitting. Let us look at the relationship between each predictor variable and the response. 
```{r feature_plot}
library(caret)
featurePlot(x=environ[1:11], y= species$Ruru)
```

```{r caret_search}

set.seed(123)

data_set <- cbind(environ[1:11], ruru = species[,24])
inTrain <- createDataPartition(data_set$ruru, p = 0.6, list = FALSE)
training <- data_set[inTrain,]
testing <-  data_set[-inTrain,]

fit <- train(ruru ~ ., 
             data = training, 
             method = "glm",
             family = "poisson",
             trControl = trainControl(method = "cv", number = 3))

summary(fit)

fit

results <- predict(fit, newdata = testing)

varImp(fit)

```