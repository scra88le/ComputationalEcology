<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Species abundance analysis</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Computational Ecology</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="1_data_analysis.html">Data Analysis</a>
    </li>
    <li>
      <a href="2_glm.html">Generalised Linear Models</a>
    </li>
    <li>
      <a href="3_gam.html">Generalised Additive Models</a>
    </li>
    <li>
      <a href="4_sdm.html">Distribution Modelling</a>
    </li>
    <li>
      <a href="5_eDNA.html">Environmental DNA</a>
    </li>
    <li>
      <a href="6_sam_naboisho.html">Geostatistics</a>
    </li>
    <li>
      <a href="7_movement_BA055.html">Movement Modelling</a>
    </li>
    <li>
      <a href="8_distance_sampling.html">Distance Sampling</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Species abundance analysis</h1>

</div>


<div id="introduction" class="section level1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<p>Geostatistics is a class of statistics used to analyze and predict the values associated with spatial or spatiotemporal phenomena. It incorporates the spatial (and in some cases temporal) coordinates of the data within the analyses. Geostatistics attempts to fit a stochastic model to the known location of a phenomenon and associated covariates, inorder to</p>
<p>Here we use a dataset of species observation locations within the Naboisho conservancy in Kenya. In this example we will model the distribution of Zebra abudaance using geostatistical techniques.</p>
<pre class="r"><code># Load libraries
library(tidyr)
library(dplyr)
library(sf)
library(ggplot2)
library(geosphere)
library(lwgeom)
library(PrevMap)
library(raster)

# Set filename of raw csv to load
rm(list = ls())  
setwd(&quot;/Users/anthony/Documents/GitHub/ComputationalEcology/&quot;)
survey &lt;- readRDS(&quot;data_analysis_files/naboisho/clean_survey.RData&quot;)</code></pre>
</div>
<div id="visualising-the-data" class="section level1">
<h1><span class="header-section-number">2</span> Visualising the data</h1>
<pre class="r"><code># Add sf POINTs to dataframe for coords
survey &lt;- survey %&gt;% 
  # Remove observations with no long, lat data
  filter(!is.na(lat) &amp; !is.na(long)) %&gt;%
  # Create sf points with WGS84
  st_as_sf(coords = c(&quot;long&quot;, &quot;lat&quot;), crs = 4326, remove = F)

# Plot overall data set
survey %&gt;%
  ggplot() +
    geom_point(aes(x=long, y=lat)) +
    facet_wrap(~transect, scale = &quot;free&quot;) +
    theme_bw()</code></pre>
<p><img src="6_sam_naboisho_files/figure-html/data_wrangling-1.png" width="672" /></p>
<div id="generating-species-locations" class="section level2">
<h2><span class="header-section-number">2.1</span> Generating species locations</h2>
<p>Now we need to generate the coordinates of all species, given the observer location (long, lat), distance between species and observer and bearing</p>
<pre class="r"><code>species_locations &lt;- geosphere::destPoint(
  # drop sf geometry and select vector of observer locations
  p = survey %&gt;% st_drop_geometry() %&gt;% dplyr::select(long,lat),
  # vector of bearings from observer to observations
  b = survey$Compass.Bearing,
  # vector of distance in meters between observer and observation
  d = survey$Distance..m.) %&gt;%
  # Convert new destinations to a dataframe
  as.data.frame() %&gt;%
  # Create sf point from species location
  st_as_sf(coords = c(&#39;lon&#39;, &#39;lat&#39;), crs = 4326, remove = F) %&gt;%
  # Project into planar coordinates for Kenya
  st_transform(32636) %&gt;%
  # Bind with relevant survey data
  cbind(
    survey %&gt;% dplyr::select(size, Region.Label, transect, species, year, month)) %&gt;%
  distinct(.keep_all=T)

# Add Easting/Northing references to datframe
species_locations &lt;- species_locations %&gt;%
  st_coordinates() %&gt;%
  cbind(species_locations) %&gt;%
  rename (easting = X,
          northing = Y) %&gt;%
  st_drop_geometry() 

# Plot all species locations
species_locations %&gt;%
  ggplot() +
    geom_point(aes(x=lon, y=lat)) +
    theme_bw()</code></pre>
<p><img src="6_sam_naboisho_files/figure-html/generate_target_locations-1.png" width="672" /></p>
<p>Looks like we have a few outliers, so let’s remove them.</p>
<pre class="r"><code># Remove the outlier
species_locations &lt;- species_locations %&gt;% 
  filter(lat &lt; -1.325) %&gt;%
  # Remove species marked as None
  filter(species != &quot;None&quot;)

#Replot
species_locations %&gt;%
    ggplot() +
    geom_point(aes(x=lon, y=lat)) +
    theme_bw() +
    facet_wrap(~species)</code></pre>
<p><img src="6_sam_naboisho_files/figure-html/remove_outliers-1.png" width="672" /></p>
<pre class="r"><code># Generate bounding box for Naboisho in WGS84
naboisho_bbox &lt;- st_bbox(species_locations$geometry)</code></pre>
</div>
</div>
<div id="spatial-zebra-observations-in-time" class="section level1">
<h1><span class="header-section-number">3</span> Spatial Zebra observations in time</h1>
<p>We want to select Zebra to generate a spatial abundance estimation. Our spatial model assumes that the random process within it is a <em>stationary process</em>. That is, the statistical properties within it are applicable across the entire spatial domain. Therefore we should select Zebra observations from a particular point in time. Below we choose observations from July 2018 only.</p>
<pre class="r"><code># Create target dataset
zebra &lt;- species_locations %&gt;% 
  filter(species == &quot;Zebra&quot;) %&gt;%
  filter(year == 2018) %&gt;%
  filter(month == &quot;Jul&quot;) %&gt;%
  # Keep only the location, count and covariates
  dplyr::select(easting, northing, size, Region.Label, transect)

# Plot Zebra in July of 2019
zebra %&gt;%
  ggplot() +
  geom_point(aes(x=easting, y=northing, size=size)) +
  theme_bw()</code></pre>
<p><img src="6_sam_naboisho_files/figure-html/filter_species-1.png" width="672" /></p>
<p>the plot above shows Zebra locations from a survey within the Naboisho conservancy as of July 2018. Note the size of the dot shows the size of the Zebra heard observed.</p>
</div>
<div id="adding-ndvi-as-a-model-covariate" class="section level1">
<h1><span class="header-section-number">4</span> Adding NDVI as a model covariate</h1>
<p>Before we generate our spatial model, we can generate a Normalised Difference Vegetation Index (NDVI) for the Naboisho conservancy. NDVI quantifies the degree of vegetation spatially by measuring the difference between reflected near-infrared (which vegetation reflects) and red light (which vegetation absorbs). We can use this spatial information as a covariate and can therefore explore the association of Zebra abundance with the degree of vegetation.</p>
<p>To generate an NDVI index we use a Landsat satellite raster from July 2018. For each 30m x 30m cell within the raster image, we process the NIR and Red light values to generate an NDVI value. The results in a set of coordinates in space, each of which with a value between -1 and 1. A value of +1 represents represents dense green vegetation and values around 0 or less represent urbanised developments.</p>
<pre class="r"><code># Load NDVI of naboisho for July 2019
ndvi_r &lt;- raster(&quot;data_analysis_files/naboisho/naboisho_ndvi_cropped&quot;) %&gt;%
  # Downsample raster to 120m x 120m cells
  aggregate(fact=8, fun=mean)
# Plot NDVI of Naboisho study region
plot(ndvi_r)</code></pre>
<p><img src="6_sam_naboisho_files/figure-html/ndvi_join-1.png" width="672" /></p>
<pre class="r"><code># Extract NDVI for each observation and bind to observation data
zebra &lt;- ndvi_r %&gt;%
  raster::extract(zebra[1:2]) %&gt;%
  cbind(zebra) %&gt;%
  dplyr::rename(ndvi = &quot;.&quot;)</code></pre>
</div>
<div id="fitting-a-variogram" class="section level1">
<h1><span class="header-section-number">5</span> Fitting a variogram</h1>
<p>A variogram captures the spatial continuity of a dataset. In our Zebra example, a variogram will give a measure of how two different observations vary in abundance as a function of distance between them. To calculate it, a function selects pairs of points (at a different distances, known as laghs) from a dataset and measures the variability between them.</p>
<p>We can use the r package <code>gstat</code> to fit and plot an empirical variogram.</p>
<pre class="r"><code>library(gstat)
coordinates(zebra) &lt;- ~ easting + northing

# Generate sample variogram values for species location data
species_vgm &lt;- gstat::variogram(size ~ ndvi, zebra)
# Fit model
species_fit &lt;- fit.variogram(species_vgm, model=vgm(1, &quot;Sph&quot;, 900,1))
#species_fit &lt;- fit.variogram(species_vgm, model=vgm(5, &quot;Sph&quot;, 8,2))
# Show model parameters
species_fit</code></pre>
<pre><code>##   model    psill    range
## 1   Nug 183.8316   0.0000
## 2   Sph 162.2805 709.7361</code></pre>
<pre class="r"><code># Plot the model fit
plot(species_vgm, species_fit)</code></pre>
<p><img src="6_sam_naboisho_files/figure-html/variogram_fit-1.png" width="672" /></p>
<p>There are three key parameters that describe the variogram:</p>
<ul>
<li><em>nugget</em> : the point at which the variograme hits the y axis.</li>
<li><em>sill</em> : the limit of the variogram tending to infinity lag distances</li>
<li><em>range</em> : the distance in which the difference of the variogram from the sill becomes negligible</li>
</ul>
<p>The range is the key parameter that helps fit our geospatial model.</p>
</div>
<div id="a-spatial-abundance-model" class="section level1">
<h1><span class="header-section-number">6</span> A spatial abundance model</h1>
<p>In order to generate a spatial abundance model from the Naboisho Zebra data, we use the r package <code>PrevMap</code> <a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. PreMap is used to analyse spatially referenced prevalance data, and uses classical maximum likelihod estimation as we as Bayesian inference to estate parameters of spatial models. In order to model species abundance counts in space, we use a geostatisical <em>poission</em> model that has its parameters estimated by using a Monte Carlo maximum likelihood estimator. We take the output of the variogram model to initiate parameterisation of the estimator.</p>
<p><img src="6_sam_naboisho_files/figure-html/fit_LA-1.png" width="672" /></p>
</div>
<div id="model-prediction" class="section level1">
<h1><span class="header-section-number">7</span> Model prediction</h1>
<p>Now we have estimated the parameters for our model, we can make a spatial abundance prediction. Inorder to make a prediction, we need to make a prediction grid that includes the NDVI covariate data that we generated earlier.</p>
<pre class="r"><code>pred_grid &lt;- ndvi_r %&gt;%
  # Convert raster to vector of points
  rasterToPoints() %&gt;%
  as.data.frame() %&gt;%
  rename(easting = x,
         northing = y,
         ndvi = layer)</code></pre>
<p>Now we can make a prediction.</p>
<pre class="r"><code># Generate prediction data
pred.MCML &lt;- spatial.pred.poisson.MCML(fit.MCML, 
                                       grid.pred = pred_grid,
                                       control.mcmc = c.mcmc,
                                       type = &quot;marginal&quot;,
                                       predictors = pred_grid,
                                       standard.errors = T,
                                       plot.correlogram = T)</code></pre>
<p><img src="6_sam_naboisho_files/figure-html/make_prediction-1.png" width="864" /></p>
<p>We can plot the spatial distribution of the mean exponential abundance together with the variance.</p>
<pre class="r"><code>predictions &lt;- cbind(exp_pred = 
                       # Select predictions
                       pred.MCML$exponential$predictions,
                     std_err =
                       # Select standard errors
                       pred.MCML$exponential$standard.errors,
                       # Against coordinate grid
                       pred_grid %&gt;% dplyr::select(easting,northing))

# Now plot predictions
predictions %&gt;%
  ggplot(aes(x=easting, y=northing)) + 
  geom_tile(aes(fill=exp_pred)) + 
  coord_equal() +
  scale_fill_viridis_c() +
  theme_bw()</code></pre>
<p><img src="6_sam_naboisho_files/figure-html/make_plot-1.png" width="672" /></p>
<p>Calculate the overall population density per km2</p>
<pre class="r"><code># Calculate total number
total_count = sum(log(pred.MCML$exponential$predictions))
total_count</code></pre>
<pre><code>## [1] 4410.131</code></pre>
<pre class="r"><code># Calculate survey area in km2
survey_area = nrow(ndvi_r) * ncol(ndvi_r) * xres(ndvi_r)/1000 * yres(ndvi_r)/1000
survey_area</code></pre>
<pre><code>## [1] 138.0672</code></pre>
<pre class="r"><code># Calculate average density per km2
density = total_count / survey_area
density</code></pre>
<pre><code>## [1] 31.94192</code></pre>
</div>
<div id="references" class="section level1">
<h1><span class="header-section-number">8</span> References</h1>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Giorgi, E., Diggle, P. J. (2016). PrevMap: an R package for prevalence mapping. Journal of Statistical Software. In press<a href="#fnref1">↩</a></p></li>
</ol>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
