<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Biodiversity Mapping</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Computational Ecology</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Vignettes
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="1_data_analysis.html">Data Analysis</a>
    </li>
    <li>
      <a href="2_glm.html">Generalised Linear Models</a>
    </li>
    <li>
      <a href="3_gam.html">Generalised Additive Models</a>
    </li>
    <li>
      <a href="4_sdm.html">Distribution Modelling</a>
    </li>
    <li>
      <a href="5_eDNA.html">Environmental DNA</a>
    </li>
    <li>
      <a href="6_sam_naboisho.html">Geostatistics</a>
    </li>
    <li>
      <a href="7_movement_BA055.html">Movement Modelling</a>
    </li>
    <li>
      <a href="8_distance_sampling.html">Distance Sampling</a>
    </li>
    <li>
      <a href="9_biodiversity.html">Spatial Biodiversity</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Biodiversity Mapping</h1>

</div>


<div id="introduction" class="section level1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<p>The Global Biodiversity Information Facility (GBIF) allows scientists to record and share species occurence information from around the world. Four our study here we will download all occurence records based on the following criteria:</p>
<ul>
<li>within the administrative boundaries of Oxford City</li>
<li>all records between 2014 to 2019</li>
<li>all human observtions (not museum specimens)</li>
<li>three taxa from the classes Aves, Mammalisa and Insecta</li>
</ul>
<p>It is likely that the GBIF data will exhibit sampling bias in a number of ways. In general, people are more interested in birds than plants!</p>
<pre class="r"><code># Load libraries
library(tidyverse)
library(rgbif)
library(sf)
library(osmdata)
library(reshape2)

# Clear environment
rm(list = ls())  </code></pre>
</div>
<div id="oxford-city-study-area" class="section level1">
<h1><span class="header-section-number">2</span> Oxford City study area</h1>
<p>First we need to obtain a shapefile for Oxford City, our study area. We can use <code>osmdata</code> from the Open Streetmap foundation to achieve this.</p>
<pre class="r"><code># Get bounding box for Oxford
bb &lt;- getbb(&#39;Oxford, U.K.&#39;)
# Query OSM for sf data
q &lt;- opq(bbox = bb) %&gt;%
  add_osm_feature(key = &#39;boundary&#39;, value = &#39;administrative&#39;) %&gt;%
  osmdata_sf()

# Convert Oxford polygon to WKT text so that we can query GBIF
ox_WKT &lt;- st_as_text(q$osm_multipolygons$geometry[q$osm_multipolygons$name==&quot;Oxford&quot;])</code></pre>
<div id="accessing-gbif-data" class="section level2">
<h2><span class="header-section-number">2.1</span> Accessing GBIF data</h2>
<p>Now we have our spatial query set-up we can query GBIF.</p>
<pre class="r"><code># Setup taxon search keys
# Aves: classKey = 212
# Mammalia: classKey = 359
# Insecta: classKey = 216

classKey &lt;- c(212,359,216)

# Query Oxford species groups
ox_sp &lt;- map(
  .x = classKey,
  ~ occ_search(geometry = ox_WKT, 
                    geom_big = &quot;bbox&quot;,
                    classKey = .x,
                    basisOfRecord = &#39;HUMAN_OBSERVATION&#39;,
                    year = &#39;2014, 2019&#39;,
                    limit = 10000,
                    hasCoordinate=TRUE,
                    fields = c(&quot;scientificName&quot;, &quot;speciesKey&quot;, &quot;year&quot;,&quot;decimalLatitude&quot;,&quot;decimalLongitude&quot;, &quot;classKey&quot; ))) %&gt;%
  rbind()</code></pre>
</div>
<div id="gbif-results" class="section level2">
<h2><span class="header-section-number">2.2</span> GBIF results</h2>
<p>Now we can manipulate the query from GBIF into a data structure useful for subsequent processing. We have three groups of data in the GBIF object <code>ox_sp</code>, each is grouped by classKey.</p>
<pre class="r"><code># Combine retuned GBIF list queries into a single dataframe 
oxf_sp_df &lt;- ox_sp %&gt;% map_df( ~pluck(.x, &quot;data&quot;))

# Let&#39;s look at the data
head(oxf_sp_df)</code></pre>
<pre><code>## # A tibble: 6 x 6
##   classKey speciesKey scientificName decimalLongitude decimalLatitude  year
##      &lt;int&gt;      &lt;int&gt; &lt;chr&gt;                     &lt;dbl&gt;           &lt;dbl&gt; &lt;int&gt;
## 1      212    2490719 Turdus merula…            -1.25            51.8  2019
## 2      212    2492462 Erithacus rub…            -1.25            51.8  2019
## 3      212    2487603 Certhia famil…            -1.26            51.8  2019
## 4      212    5231763 Prunella modu…            -1.25            51.8  2019
## 5      212    5229493 Garrulus glan…            -1.25            51.8  2019
## 6      212    2475532 Alcedo atthis…            -1.24            51.8  2019</code></pre>
<pre class="r"><code>#How many observations do we have per taxa?
oxf_sp_df %&gt;% count(classKey) </code></pre>
<pre><code>## # A tibble: 3 x 2
##   classKey     n
##      &lt;int&gt; &lt;int&gt;
## 1      212  9481
## 2      216   806
## 3      359   313</code></pre>
</div>
</div>
<div id="spatial-grid" class="section level1">
<h1><span class="header-section-number">3</span> Spatial Grid</h1>
<p>We need to generate a grid over the Oxford survey area. This will be used to calculate a biodiversity index for each cell within the grid.</p>
<pre class="r"><code># Create a 
ox_poly &lt;- st_as_sf(q$osm_multipolygons %&gt;% filter(name==&quot;Oxford&quot;)) %&gt;%
  # Transform coordinates to planar
  st_transform(27700)

# Make a grid of Oxford city
grid_sf &lt;- st_make_grid(
  # Oxford City boundary
  ox_poly, 
  # Cell width in m
  cellsize = 400, 
  # Cells are hexagons
  square = F)

# Plot it
plot(grid_sf, main = &quot;400m wide grid cells covering Oxford City&quot;)</code></pre>
<p><img src="9_biodiversity_files/figure-html/create_grid-1.png" width="672" /></p>
</div>
<div id="spatial-analysis" class="section level1">
<h1><span class="header-section-number">4</span> Spatial Analysis</h1>
<p>Now let’s map species locations to a grid cell.</p>
<pre class="r"><code># Creat sf locatons for species locations in GBIF object 
ox_sp_sf &lt;- oxf_sp_df %&gt;% st_as_sf(coords=c(&quot;decimalLongitude&quot;,&quot;decimalLatitude&quot;),
                                    # Set crs to WGS84
                                    crs = 4326) %&gt;%
  # Reproject to plannar coordinates
  st_transform(27700)

# Add a cell id to the Oxford grid
grid_sf &lt;- grid_sf %&gt;%
  st_sf() %&gt;%
  mutate(cell_id = row_number())

# Generate intersection
intersect &lt;- st_intersects(
  # sf list of species occurences
  ox_sp_sf, 
  # sf grid of Oxford
  grid_sf, 
  # map points to gridcell
  prepared = T) %&gt;%
  # return dataframe
  as.data.frame()

# update column names
names(intersect) &lt;- c(&quot;spec_no&quot;, &quot;cell_id&quot;)

# Create a single table mapping species occurences to cells
grid_species_df &lt;- ox_sp_sf %&gt;% 
  # Create dataframe from result
  as.data.frame %&gt;% 
  # Join with grid/coordinate intersection
  cbind(intersect) %&gt;% 
  # We don&#39;t need column spec_no
  dplyr::select(-spec_no) %&gt;%
  # Group and arrange by grid cell ID
  group_by(cell_id) %&gt;%
  arrange(cell_id)

# Plot histogram for each taxa
grid_species_df %&gt;% 
  # Count by cell_id
  ggplot(aes(x=cell_id)) + 
  # Set histogram bin size
  geom_histogram(binwidth=10) + 
  # More Aves taxa records
  facet_wrap(~classKey, scales = &quot;free_y&quot;) +
  ggtitle(&quot;Histogram of grid cells, by taxa (different y scales)&quot;) +
  theme_bw() </code></pre>
<p><img src="9_biodiversity_files/figure-html/map_species_cell-1.png" width="672" /></p>
</div>
<div id="spatial-biodiversity" class="section level1">
<h1><span class="header-section-number">5</span> Spatial Biodiversity</h1>
<p>For each taxa, Calculate the Shannon index for each grid cell</p>
<pre class="r"><code># Load vegan to generate shannon index
library(vegan)


# Function to count the number of species for each grid cell
n_species_cell &lt;- function(df) {
  
  df %&gt;% 
  group_by(cell_id,speciesKey) %&gt;% 
  # Count a given species within a cell
  tally() %&gt;%
  # We need to ungroup to complete
  ungroup() %&gt;%
  # For cells with now species, fill with zeros
  complete(cell_id = 1:nrow(grid_sf), fill=list(n=0))
}

# Count species count grid for each taxa
results &lt;-grid_species_df %&gt;% 
  # Nest by class key
  nest(-classKey) %&gt;%
  # Calculate count by speces and store in separate column
  mutate(n_species_cell = map(data, ~n_species_cell(.x)))

# Function to Create a table of cells by species occurence counts
cell_diversity &lt;- function(df) 
  df %&gt;% 
  pivot_wider(
    id_cols = c(&quot;cell_id&quot;, &quot;speciesKey&quot;),
    names_from = speciesKey, 
    values_from = n, 
    values_fill = list(n=0)) %&gt;%
  # We can remove cell_id once we have a complete table
  dplyr::select(-cell_id) %&gt;%
  # Calculate shannon diversity for each cell
  diversity(&quot;shannon&quot;) %&gt;% as.data.frame()

# Calculate shannon diversity in each cell per taxa
results &lt;- results %&gt;%
  mutate(cell_diversity = map(n_species_cell, ~cell_diversity(.x)))

# Add cell shannon diversity to the grid cell sfc
out &lt;- results %&gt;% 
  pluck(&quot;cell_diversity&quot;) %&gt;% 
  as.data.frame()

# Name the columns  with their classKey
names(out) &lt;- c(&quot;Insecta&quot;, &quot;Mammalia&quot;, &quot;Aves&quot;)

# melt data to create one spatial dataset for diversity by grid cell
diversity_grid_sf &lt;- out %&gt;% 
  # Add cell_is as index
  mutate(cell_id = row_number()) %&gt;%
  # melt data with cell_id as index var
  melt(id.vars = &quot;cell_id&quot;, measure.vars = c(&quot;Insecta&quot;,&quot;Mammalia&quot;,&quot;Aves&quot;)) %&gt;%
  # join with sf grid polygons
  full_join(grid_sf) %&gt;%
  # Convert dataframe to simple feature collection for plotting
  st_as_sf()</code></pre>
</div>
<div id="plot-results" class="section level1">
<h1><span class="header-section-number">6</span> Plot Results</h1>
<p>We can add a Google background map of Oxford to see where the biodiversity hotspots are.</p>
<pre class="r"><code>library(ggmap)
register_google(key=&quot;****&quot;, write = T)
ox_basemap &lt;- get_map(bb)</code></pre>
<pre class="r"><code>ox_basemap &lt;- readRDS(&quot;oxford_basemap&quot;)</code></pre>
<p>Now we have a Google basemap, let’s visualise this.</p>
<pre class="r"><code>library(ggmap)
library(viridis)

# Create map objects and nest in data frame  
diversity_grid_sf &lt;- diversity_grid_sf %&gt;% 
  nest(-variable) %&gt;%
  mutate(plot = map2(data, 
                     variable, 
                     ~ ggmap(ox_basemap) +
                       # Overlay grid data
                       geom_sf(data = .x, 
                       # Fill with Shannon index for each grid cell         
                       aes(fill=value, geometry = geometry), 
                       inherit.aes = F,
                       alpha = 0.5) +
                       # Title of plot
                       ggtitle(.y) +
                       scale_fill_viridis() +
                       # Convert grid data to WGS84
                       coord_sf(crs=st_crs(4326))))

# Now plots and data are nicely stored together
head(diversity_grid_sf)</code></pre>
<pre><code>## # A tibble: 3 x 3
##   variable data               plot  
##   &lt;fct&gt;    &lt;list&gt;             &lt;list&gt;
## 1 Insecta  &lt;tibble [378 × 3]&gt; &lt;gg&gt;  
## 2 Mammalia &lt;tibble [378 × 3]&gt; &lt;gg&gt;  
## 3 Aves     &lt;tibble [378 × 3]&gt; &lt;gg&gt;</code></pre>
<pre class="r"><code># Plot the results
print(diversity_grid_sf$plot)</code></pre>
<pre><code>## [[1]]</code></pre>
<p><img src="9_biodiversity_files/figure-html/plot_all-1.png" width="960" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="9_biodiversity_files/figure-html/plot_all-2.png" width="960" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="9_biodiversity_files/figure-html/plot_all-3.png" width="960" /></p>
</div>
<div id="discussion" class="section level1">
<h1><span class="header-section-number">7</span> Discussion</h1>
<p>We can see some interesting results here. As this is not a controlled and randomised set of data, clearly there is significant sampling bias. That being the case, each taxa class clearly show some interesting results when the spatial Shannon diversity is plotted as above:</p>
<ul>
<li>Insecta - there seems to be a hotspot in the north of Port Meadow. Presumably as this is an ancient wet meadow without any significant human development there maybe noticeable insect diversity here. We can see from the map that most sampling has not been within built up areas.</li>
<li>Mammalia - it seems there are two biodiversity hotspots for mammals in the data analysed. One at the eastern end of Oxford golf course, and the second along <em>Mesopotamia way</em> that runs along the River Cherwell.</li>
<li>Aves - this class had by far the largets number of records, and shows a relatively high density in the centre of the city. There is a diversity hot spot next to the <em>Thames</em> on Port Meadow and alos an area near <em>Ifley Meadows</em> (a local nature reserve). As these are both sites with the Thames running through them, the higher diversity could be due to the inclusion of water fowl?</li>
</ul>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
